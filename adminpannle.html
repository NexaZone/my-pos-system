<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D64213">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NexaZone POS">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1157/1157109.png">
    
    <title>NexaZone POS Ultimate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary-color: #D64213;
            --primary-gradient: linear-gradient(135deg, #D64213 0%, #b9360f 100%);
            --primary-shadow: rgba(214, 66, 19, 0.4);
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --input-bg: #F9FAFB;
            --table-head-bg: #F9FAFB;
            --hover-bg: #F3F4F6;
        }

        body.dark-mode {
            --bg-body: #111827;
            --bg-card: #1F2937;
            --text-main: #F9FAFB;
            --text-muted: #9CA3AF;
            --border-color: #374151;
            --input-bg: #374151;
            --table-head-bg: #374151;
            --hover-bg: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; position: relative; transition: background 0.3s, color 0.3s; }
        
        /* BACKGROUND */
        .area { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0; }
        .circles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: var(--primary-shadow); animation: animate 25s linear infinite; bottom: -150px; border-radius: 4px; }
        .circles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .circles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .circles li:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        @keyframes animate { 
            0% { transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 
            100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } 
        }

        /* LOADER */
        #loader-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-body); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease-out; }
        .spinner-glow { width: 70px; height: 70px; border-radius: 50%; border: 4px solid transparent; border-top-color: var(--primary-color); border-right-color: var(--primary-color); box-shadow: 0 0 20px var(--primary-shadow); animation: spin 1s linear infinite; margin-bottom: 25px; }
        .brand-loading-text { font-size: 28px; font-weight: 700; color: var(--text-main); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 5000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .login-box { background: var(--bg-card); padding: 35px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; width: 380px; border-top: 5px solid var(--primary-color); }
        .login-box h2 { color: var(--primary-color); margin-bottom: 20px; }
        .login-box input, .login-box select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; outline: none; background: var(--input-bg); color: var(--text-main); transition: 0.3s; margin-bottom: 10px; }
        .login-box input:focus { border-color: var(--primary-color); }
        input[type="color"] { -webkit-appearance: none; border: none; width: 50px; height: 45px; padding: 0; overflow: hidden; border-radius: 8px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }

        /* BUTTONS */
        button { cursor: pointer; font-family: 'Segoe UI', sans-serif; letter-spacing: 0.5px; transition: all 0.3s ease; }
        .login-box button, .btn-primary, .btn-save { width: 100%; padding: 14px; background: var(--primary-gradient); color: white; border: none; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 15px var(--primary-shadow); }
        .login-box button:hover, .btn-primary:hover, .btn-save:hover { transform: translateY(-2px); box-shadow: 0 8px 20px var(--primary-shadow); }
        .btn-primary { width: auto; padding: 10px 20px; display: flex; align-items: center; gap: 8px; }
        .btn-cancel { background: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-muted); padding: 10px 20px; border-radius: 8px; font-weight: 600; }
        .btn-cancel:hover { background: var(--hover-bg); color: var(--text-main); }
        .btn-icon { width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-card); display: inline-flex; align-items: center; justify-content: center; margin: 0 2px; font-size: 13px; color: var(--text-main); }
        .btn-icon:hover { background: var(--hover-bg); transform: scale(1.05); }
        .btn-logout { width: 100%; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; }
        .btn-main { padding: 10px 20px; border: none; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* SPECIAL BUTTON FOR PDF */
        .btn-pdf-send {
            background-color: #059669; /* Green color */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-pdf-send:hover { background-color: #047857; }

        /* LAYOUT */
        .app-container { display: flex; height: 100vh; position: relative; z-index: 10; display: none; }
        .sidebar { width: 260px; background: var(--primary-gradient); color: white; display: flex; flex-direction: column; padding: 20px 0; box-shadow: 4px 0 15px rgba(0,0,0,0.1); transition: 0.3s; }
        .brand { padding: 0 25px; margin-bottom: 30px; font-size: 24px; font-weight: 800; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.3s; font-size: 16px; border-left: 4px solid transparent; opacity: 0.9; }
        .nav-item:hover, .nav-item.active { background-color: rgba(255, 255, 255, 0.15); border-left-color: white; font-weight: 600; opacity: 1; }
        .sidebar-footer { padding: 15px 25px; margin-top: auto; background: rgba(0,0,0,0.1); }

        .main-content { flex: 1; padding: 20px 30px; overflow-y: auto; background: transparent; display: flex; flex-direction: column; }
        .page-view { width: 100%; }
        .page-view.hidden { display: none; }
        .page-title { font-size: 28px; color: var(--text-main); margin-top: 0; margin-bottom: 25px; font-weight: 800; }

        /* WEATHER WIDGET */
        .weather-card {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white; padding: 20px; border-radius: 16px; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        .weather-info h2 { font-size: 32px; margin: 0; }
        .weather-icon { font-size: 40px; opacity: 0.9; }

        /* STATS */
        .stats-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; background: var(--bg-card); padding: 25px; border-radius: 16px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .stat-card h3 { font-size: 32px; color: var(--text-main); margin: 0; font-weight: 800; }
        .icon-box { width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .blue-accent .icon-box { color: #3B82F6; background: #EFF6FF; }
        .green-accent .icon-box { color: #10B981; background: #ECFDF5; }
        .purple-accent .icon-box { color: #8B5CF6; background: #F5F3FF; }

        /* TABLES */
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .search-bar { position: relative; width: 300px; }
        .search-bar input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); outline: none; }
        .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .table-container { background: var(--bg-card); border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: var(--table-head-bg); padding: 18px 25px; text-align: left; font-weight: 700; color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
        td { padding: 18px 25px; border-bottom: 1px solid var(--border-color); color: var(--text-main); font-size: 14px; vertical-align: middle; }
        tr:hover td { background-color: var(--hover-bg); }
        
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
        .product-card { background: var(--bg-card); border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.05); position: relative; transition: transform 0.3s; border: 1px solid var(--border-color); }
        .product-card:hover { transform: translateY(-5px); }
        .product-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 12px; margin-bottom: 15px; background-color: var(--hover-bg); }
        .product-card h4 { font-size: 16px; margin-bottom: 5px; color: var(--text-main); }
        .product-card span { font-weight: bold; color: var(--primary-color); font-size: 18px; display: block; margin: 10px 0; }
        .stock-badge { position: absolute; top: 15px; right: 15px; background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        
        .category-badge { display:inline-block; font-size:10px; background:var(--hover-bg); padding:2px 6px; border-radius:4px; margin-top:5px; color:var(--text-muted); }

        /* KEY BANK STYLES */
        .key-bank-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .key-bank-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .key-bank-header img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .key-row { display: flex; align-items: center; justify-content: space-between; background: var(--hover-bg); padding: 10px; border-radius: 8px; margin-bottom: 8px; font-family: monospace; font-size: 14px; }
        .key-actions { display: flex; gap: 10px; }
        .key-select { padding: 5px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 6000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: var(--bg-card); width: 450px; padding: 35px; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); animation: modalPop 0.3s ease-out; color: var(--text-main); max-height: 90vh; overflow-y: auto; }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .input-group { margin-bottom: 18px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; outline: none; background: var(--input-bg); color: var(--text-main); }
        .input-group input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-shadow); }
        .input-group label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-muted); font-weight: 600; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 25px; }

        .whatsapp-link { color: #059669; text-decoration: none; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; background: #ecfdf5; padding: 5px 10px; border-radius: 20px; font-size: 12px; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; display: inline-block; }
        
        .status-active { background-color: #D1FAE5; color: #065F46; } /* Green */
        .status-expired { background-color: #FEE2E2; color: #991B1B; } /* Red */
        .status-sale { background-color: #DBEAFE; color: #1E40AF; } /* Blue */
        .status-replaced { background-color: #F3F4F6; color: #6B7280; text-decoration: line-through; } /* Grey */
        
        .alert-card { background-color: #FEF2F2; border-left: 4px solid #F87171; padding: 15px 20px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; color: #991B1B; }
        .empty-placeholder { background: var(--bg-card); padding: 40px; border-radius: 12px; text-align: center; color: var(--text-muted); border: 2px dashed var(--border-color); margin-top: 20px; font-style: italic; }
        .settings-card { background: var(--bg-card); padding: 25px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); color: var(--text-main); }
        .settings-card h3 { margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; color: var(--text-main); }
        
        .top-list { list-style: none; padding: 0; }
        .top-list li { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; align-items: center; color: var(--text-main); }
        .top-rank { background: var(--primary-gradient); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 12px; font-weight: bold; box-shadow: 0 2px 5px var(--primary-shadow); }

        .log-entry { font-size: 13px; padding: 10px 0; border-bottom: 1px solid var(--border-color); color: var(--text-muted); display: flex; align-items: center; }
        .log-time { color: var(--text-muted); font-size: 11px; margin-right: 15px; min-width: 120px; }

        .profile-btn { background: rgba(255,255,255,0.15); padding: 12px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; margin-bottom: 10px; }
        .profile-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }
        .tool-row { display: flex; gap: 10px; }
        .tool-btn { flex: 1; background: rgba(0,0,0,0.2); border: none; padding: 8px; border-radius: 8px; color: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .tool-btn:hover { background: rgba(0,0,0,0.4); }

        @media print {
            body * { visibility: hidden; }
            #invoice-print-area, #invoice-print-area * { visibility: visible; }
            #invoice-print-area { position: absolute; left: 0; top: 0; width: 100%; color: black; }
        }
    </style>
</head>
<body>

    <div id="loader-wrapper">
        <div class="spinner-glow"></div>
        <h2 class="brand-loading-text brand-text">NexaZone Digital</h2>
        <p style="color:#888;">Loading...</p>
    </div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 class="brand-text">POS Login</h2>
            <div class="input-group" style="text-align:left;"><label>Your Brand Name</label><input type="text" id="loginBrandName" placeholder="Ex: My Shop" oninput="previewBrand(this.value)"></div>
            <div class="input-group" style="text-align:left;"><label>Brand Theme Color</label><div style="display:flex; gap:10px;"><input type="color" id="loginBrandColor" value="#D64213" onchange="previewColor(this.value)" style="flex:none;"><input type="text" id="loginBrandColorHex" value="#D64213" readonly style="flex:1; color:#666;"></div></div>
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            <div class="input-group"><input type="email" id="loginEmail" placeholder="Email Address"></div>
            <div class="input-group"><input type="password" id="loginPass" placeholder="Password"></div>
            <button onclick="attemptLogin()">Access Dashboard</button>
        </div>
    </div>

    <div class="area"><ul class="circles"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul></div>

    <div class="app-container" id="main-app">
        <aside class="sidebar">
            <div class="brand brand-text">NexaZone</div>
            <ul class="nav-menu">
                <li onclick="navigate('home')" class="nav-item active" id="nav-home"><i class="fas fa-home"></i> <span data-i18n="home">Home</span></li>
                <li onclick="navigate('orders')" class="nav-item" id="nav-orders"><i class="fas fa-shopping-cart"></i> <span data-i18n="orders">Orders</span></li>
                <li onclick="navigate('payments')" class="nav-item" id="nav-payments"><i class="fas fa-file-invoice-dollar"></i> <span data-i18n="payments">Payments</span></li>
                <li onclick="navigate('products')" class="nav-item" id="nav-products"><i class="fas fa-box-open"></i> <span data-i18n="products">Products</span></li>
                
                <li onclick="navigate('keys')" class="nav-item" id="nav-keys"><i class="fas fa-key"></i> Key Bank</li>
                
                <li onclick="navigate('customers')" class="nav-item" id="nav-customers"><i class="fas fa-users"></i> <span data-i18n="customers">Customers</span></li>
                <li onclick="navigate('reports')" class="nav-item" id="nav-reports"><i class="fas fa-chart-line"></i> <span data-i18n="reports">Reports</span></li>
                <li onclick="navigate('logs')" class="nav-item" id="nav-logs"><i class="fas fa-history"></i> <span data-i18n="logs">Logs</span></li>
                <li onclick="navigate('settings')" class="nav-item" id="nav-settings"><i class="fas fa-cog"></i> <span data-i18n="settings">Settings</span></li>
            </ul>
            <div class="sidebar-footer">
                <div class="profile-btn" onclick="openProfile()">
                    <i class="fas fa-user-circle" style="font-size:24px;"></i>
                    <div style="margin-left:5px;">
                        <span style="font-size:13px; font-weight:bold; display:block;">My Account</span>
                        <small style="font-size:11px; opacity:0.8;">View Status</small>
                    </div>
                </div>
                <div class="tool-row">
                    <button class="tool-btn" onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Dark</button>
                    <button class="tool-btn" onclick="toggleLang()"><i class="fas fa-language"></i> <span id="curr-lang">EN</span></button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <section id="home" class="page-view">
                <h1 class="page-title" data-i18n="dashboard">Dashboard</h1>
                <div id="weather-widget" class="weather-card">
                    <div class="weather-info">
                        <h3>Colombo, LK</h3>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-cloud-sun weather-icon"></i>
                            <h2 id="weather-temp">Loading...</h2>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <p id="weather-desc">Fetching data...</p>
                        <small id="weather-date"></small>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-card blue-accent"><div class="icon-box"><i class="fas fa-shopping-cart"></i></div><div class="info"><small style="color:var(--text-muted); font-weight:600;">ORDERS</small><h3 id="dash-orders-count">0</h3></div></div>
                    <div class="stat-card green-accent"><div class="icon-box"><i class="fas fa-box"></i></div><div class="info"><small style="color:var(--text-muted); font-weight:600;">PRODUCTS</small><h3 id="dash-products-count">0</h3></div></div>
                    <div class="stat-card purple-accent"><div class="icon-box"><i class="fas fa-user-friends"></i></div><div class="info"><small style="color:var(--text-muted); font-weight:600;">CUSTOMERS</small><h3 id="dash-customers-count">0</h3></div></div>
                </div>
                <div id="expiration-alerts"></div>
            </section>

            <section id="orders" class="page-view hidden">
                <div class="header-flex"><h1 class="page-title" data-i18n="orders">Orders</h1><button class="btn-primary" onclick="openModal('modalOrder')"><i class="fas fa-plus"></i> <span data-i18n="add">Add Order</span></button></div>
                <div class="table-container"><table><thead><tr><th>CUSTOMER</th><th>PRODUCT</th><th>TYPE</th><th>STATUS</th><th>START</th><th>END</th><th>ACTION</th></tr></thead><tbody id="tableOrders"></tbody></table></div>
            </section>

            <section id="payments" class="page-view hidden">
                <div class="header-flex">
                    <h1 class="page-title" data-i18n="payments">Payments</h1>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-primary" style="background:#4F46E5" onclick="window.open('https://stripe.com','_blank')"><i class="fas fa-credit-card"></i> Pay Online</button>
                        <button class="btn-primary" onclick="openModal('modalPayment')"><i class="fas fa-plus"></i> Add Payment</button>
                    </div>
                </div>
                <div class="table-container"><table><thead><tr><th>CUSTOMER</th><th>AMOUNT</th><th>STATUS</th><th>ACTION</th></tr></thead><tbody id="tablePayments"></tbody></table></div>
            </section>

            <section id="products" class="page-view hidden">
                <div class="header-flex">
                    <h1 class="page-title" data-i18n="products">Products</h1>
                    
                    <div style="display:flex; gap:10px;">
                        <input type="file" id="excelInput" style="display:none" onchange="importExcel(this)" accept=".xlsx, .xls">
                        <button class="btn-primary" style="background:#10B981" onclick="downloadTemplate()"><i class="fas fa-file-download"></i> Template</button>
                        <button class="btn-primary" style="background:#3B82F6" onclick="document.getElementById('excelInput').click()"><i class="fas fa-file-upload"></i> Import</button>
                        <button class="btn-primary" onclick="openModal('modalProduct')"><i class="fas fa-plus"></i> <span data-i18n="add">Add Product</span></button>
                    </div>
                </div>
                <div class="products-grid" id="productsGrid"></div>
            </section>

            <section id="keys" class="page-view hidden">
                <div class="header-flex">
                    <h1 class="page-title">Key Bank Management</h1>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-primary" style="background:#8B5CF6" onclick="openAddKeyModal('bulk')">
                            <i class="fas fa-layer-group"></i> Bulk Add
                        </button>
                        <button class="btn-primary" style="background:#10B981" onclick="openAddKeyModal('single')">
                            <i class="fas fa-key"></i> Add Single
                        </button>
                    </div>
                </div>
                <div id="key-bank-container"></div>
            </section>

            <section id="customers" class="page-view hidden">
                <div class="header-flex">
                    <h1 class="page-title" data-i18n="customers">Customers</h1>
                    <div class="search-bar"><i class="fas fa-search"></i><input type="text" placeholder="Search Name/ID..." onkeyup="searchCustomer(this.value)"></div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-primary" style="background:#EA580C" onclick="sendPromo()"><i class="fas fa-envelope"></i> Promo</button>
                        <button class="btn-primary" onclick="openModal('modalCustomer')"><i class="fas fa-plus"></i> Add</button>
                    </div>
                </div>
                <div class="table-container"><table><thead><tr><th>NAME</th><th>MEM. ID</th><th>WHATSAPP</th><th>STARS</th><th>ACTION</th></tr></thead><tbody id="tableCustomers"></tbody></table></div>
            </section>

            <section id="reports" class="page-view hidden">
                <h1 class="page-title" data-i18n="reports">Analytics</h1>
                <div class="settings-card" style="margin-bottom:20px;">
                    <h3>Sales Overview (Last 7 Days)</h3>
                    <canvas id="salesChart" style="max-height: 300px; width:100%;"></canvas>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
                    <div class="settings-card"><h3>Sales Summary</h3><h2 id="rep-total" style="color:var(--primary-color); font-size:36px; margin:20px 0;">LKR 0</h2></div>
                    <div class="settings-card"><h3>Top Selling</h3><ul class="top-list" id="top-selling-list"></ul></div>
                </div>
            </section>

            <section id="logs" class="page-view hidden">
                <h1 class="page-title" data-i18n="logs">Activity Logs</h1>
                <div class="settings-card"><div id="logs-container" style="max-height:400px; overflow-y:auto;"></div></div>
            </section>

            <section id="settings" class="page-view hidden">
                <h1 class="page-title" data-i18n="settings">Settings</h1>
                <div class="settings-card" style="max-width:500px;">
                    <h3>Invoice Config</h3>
                    <form onsubmit="saveShopSettings(event)">
                        <div class="input-group"><label>Shop Name</label><input type="text" id="setShopName"></div>
                        <div class="input-group"><label>Address</label><input type="text" id="setShopAddr"></div>
                        <div class="input-group"><label>Phone</label><input type="text" id="setShopPhone"></div>
                        <div class="input-group"><label>Receipt Footer Message</label><input type="text" id="setFooter" placeholder="Thank you come again!"></div>
                        <div class="modal-actions"><button type="submit" class="btn-save">Save Changes</button></div>
                    </form>
                </div>
                <div class="settings-card" style="max-width:500px;">
                    <h3>Backup</h3>
                    <button class="btn-main" onclick="backupData()" style="background:#3B82F6;">Download</button>
                    <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
                    <button class="btn-main" onclick="document.getElementById('restoreFile').click()" style="background:#10B981;">Restore</button>
                </div>
            </section>
        </main>
    </div>

    <div id="invoice-print-area" style="display:none; padding:20px; font-family:monospace;">
        <h2 style="text-align:center;" class="brand-text" id="inv-shop-name">NexaZone Digital</h2>
        <p style="text-align:center; font-size:12px;" id="inv-shop-details"></p>
        <hr>
        <div id="inv-details"></div>
        <hr>
        <h3 id="inv-total" style="text-align:right;"></h3>
        <p style="text-align:center; margin-top:10px; font-size:12px;" id="inv-warranty"></p>
        <p style="text-align:center; margin-top:20px; font-weight:bold;" id="inv-footer">Thank You!</p>
    </div>

    <div id="modalPayment" class="modal-overlay"><div class="modal-box"><h3>Add Payment</h3><form onsubmit="handlePayment(event)"><div class="input-group"><label>Customer</label><select id="payCust" required><option value="">Select...</option></select></div><div class="input-group"><label>Amount</label><input type="number" id="payAmount" required></div><div class="input-group"><label>Status</label><select id="payStatus"><option>Pending</option><option>Complete</option></select></div><div class="modal-actions"><button type="button" class="btn-cancel" onclick="closeModal('modalPayment')">Cancel</button><button type="submit" class="btn-save">Save</button></div></form></div></div>
    
    <div id="modalProduct" class="modal-overlay"><div class="modal-box"><h3>Add Product</h3><form onsubmit="handleProduct(event)">
        <div class="input-group"><label>Name</label><input type="text" id="pName" required></div>
        <div class="input-group"><label>Category</label><select id="pCat"><option>Electronics</option><option>Fashion</option><option>Food</option><option>Software</option><option>Other</option></select></div>
        <div class="input-group"><label>Desc</label><textarea id="pDesc"></textarea></div>
        <div class="input-group"><label>Price (LKR)</label><input type="number" id="pPrice" required></div>
        <div class="input-group"><label>Warranty Period</label><input type="text" id="pWarranty" placeholder="Ex: 1 Year"></div>
        <div class="input-group"><label>Stock</label><input type="number" id="pStock" required></div>
        <div class="input-group"><label>Image</label><input type="file" id="pImg" required></div>
        <div class="modal-actions"><button type="button" class="btn-cancel" onclick="closeModal('modalProduct')">Cancel</button><button type="submit" class="btn-save">Save</button></div>
    </form></div></div>

    <div id="modalBulkKeys" class="modal-overlay"><div class="modal-box"><h3>Bulk Add Keys</h3>
        <div class="input-group"><label>Select Product</label><select id="keyProdSelectBulk" required><option value="">Loading...</option></select></div>
        <div class="input-group"><label>Paste Keys (One per line)</label><textarea id="newKeyDataBulk" rows="6" placeholder="Key 1&#10;Key 2&#10;Key 3"></textarea></div>
        <div class="modal-actions"><button type="button" class="btn-cancel" onclick="closeModal('modalBulkKeys')">Cancel</button><button type="button" class="btn-save" onclick="handleSaveBulkKeys()">Save Bulk</button></div>
    </div></div>

    <div id="modalSingleKey" class="modal-overlay"><div class="modal-box"><h3>Add Single Key/Data</h3>
        <div class="input-group"><label>Select Product</label><select id="keyProdSelectSingle" required><option value="">Loading...</option></select></div>
        <div class="input-group"><label>Enter Data (Email/Pass etc.)</label><textarea id="newKeyDataSingle" rows="6" placeholder="Email: user@mail.com&#10;Pass: 123456&#10;Recovery: xyz"></textarea><small style="color:#666;">This whole block will be treated as ONE key.</small></div>
        <div class="modal-actions"><button type="button" class="btn-cancel" onclick="closeModal('modalSingleKey')">Cancel</button><button type="button" class="btn-save" onclick="handleSaveSingleKey()">Save Single</button></div>
    </div></div>

    <div id="modalCustomer" class="modal-overlay"><div class="modal-box"><h3>Add Customer</h3><form onsubmit="handleCustomer(event)">
        <div class="input-group"><label>Name</label><input type="text" id="cName" required></div>
        <div class="input-group"><label>Membership ID</label><input type="text" id="cMemId" placeholder="Auto-generated if empty"></div>
        <div class="input-group"><label>WhatsApp</label><input type="tel" id="cPhone" required></div>
        <div class="input-group"><label>Date</label><input type="date" id="cDate" required></div>
        <div class="modal-actions"><button type="button" class="btn-cancel" onclick="closeModal('modalCustomer')">Cancel</button><button type="submit" class="btn-save">Save</button></div>
    </form></div></div>

    <div id="modalOrder" class="modal-overlay">
        <div class="modal-box">
            <h3>Add Order</h3>
            <form onsubmit="handleOrder(event)">
                <div class="input-group">
                    <label>Customer</label>
                    <select id="oCust" required><option value="">Select...</option></select>
                </div>
                <div class="input-group">
                    <label>Product</label>
                    <select id="oProd" required onchange="updPrice()"><option value="">Select...</option></select>
                </div>
                <div class="input-group">
                    <label>Price</label>
                    <input type="number" id="oPrice" readonly>
                </div>
                <div class="input-group">
                    <label>Qty</label>
                    <input type="number" id="oQty" value="1" oninput="calcTot()">
                </div>
                <div class="input-group">
                    <label>Total</label>
                    <input type="number" id="oTotal" readonly>
                </div>
                <div class="input-group">
                    <label>Type</label>
                    <select id="oType" onchange="toggleSubFields()">
                        <option value="Sale">One-time Sale</option>
                        <option value="Subscription">Subscription (Recurring)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Upload Payment Slip (Optional)</label>
                    <input type="file" id="oSlip">
                </div>

                <div id="subFields" style="display:none; background:#eff6ff; padding:10px; border-radius:8px; border:1px solid #bfdbfe; margin-bottom:15px;">
                    <div class="input-group">
                        <label style="color:#1e40af;">Start Date</label>
                        <input type="date" id="oStart">
                    </div>
                    <div class="input-group">
                        <label style="color:#1e40af;">End Date</label>
                        <input type="date" id="oEnd">
                    </div>
                </div>

                <div class="input-group">
                    <label>Invoice Date</label>
                    <input type="date" id="oDate" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('modalOrder')">Cancel</button>
                    <button type="submit" class="btn-save">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalViewSlip" class="modal-overlay"><div class="modal-box" style="text-align:center;">
        <h3>Payment Slip</h3>
        <img id="viewSlipImg" src="" style="max-width:100%; border-radius:8px; margin-bottom:15px;">
        <button class="btn-cancel" onclick="closeModal('modalViewSlip')" style="width:100%;">Close</button>
    </div></div>

    <div id="modalHistory" class="modal-overlay"><div class="modal-box"><h3>Purchase History</h3><div id="history-content" style="max-height:300px;overflow-y:auto;"></div><button class="btn-cancel" onclick="closeModal('modalHistory')" style="width:100%;margin-top:15px;">Close</button></div></div>

    <div id="modalProfile" class="modal-overlay"><div class="modal-box" style="width: 400px;"><div style="text-align:center; margin-bottom:20px;"><div style="width:80px; height:80px; background:var(--primary-gradient); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; margin:0 auto 15px;"><i class="fas fa-user"></i></div><h3 id="prof-email">User Email</h3></div><div class="countdown-box"><div class="countdown-label">Access Expires In</div><div id="prof-countdown" class="countdown-time">Calculating...</div></div><div style="text-align:center; margin-bottom:25px; font-size:14px; color:#555;"><p><strong>Start:</strong> <span id="prof-start">-</span> | <strong>End:</strong> <span id="prof-end">-</span></p></div><button class="btn-logout" onclick="logout()">Logout Session</button><button class="btn-cancel" style="width:100%; margin-top:10px;" onclick="closeModal('modalProfile')">Close</button></div></div>

    <script>
        setTimeout(function(){
            var l=document.getElementById('loader-wrapper');
            if(l){
                l.style.opacity='0';
                setTimeout(()=>l.style.display='none',500);
            }
        },2000);

        let currentUserEmail = localStorage.getItem('nz_current_user');
        let data = { orders:[], products:[], customers:[], payments:[], logs:[], settings: {} };
        let salesChartInstance = null;
        let currentLang = localStorage.getItem('nz_lang') || 'en';
        let isDarkMode = localStorage.getItem('nz_dark_mode') === 'true';

        const translations = {
            en: { home: "Home", orders: "Orders", payments: "Payments", products: "Products", customers: "Customers", reports: "Reports", logs: "Activity Logs", settings: "Settings", dashboard: "Dashboard", add: "Add" },
            si: { home: "මුල් පිටුව", orders: "ඇණවුම්", payments: "ගෙවීම්", products: "භාණ්ඩ", customers: "පාරිභෝගික", reports: "වාර්තා", logs: "ක්‍රියා", settings: "සැකසුම්", dashboard: "උපකරණ පුවරුව", add: "එකතු" }
        };

        if(currentUserEmail) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            loadData();
            applyBranding();
            applyTheme();
            applyLang();
            fetchWeather();
        }

        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=6.9271&longitude=79.8612&current_weather=true');
                const wData = await res.json();
                document.getElementById('weather-temp').innerText = wData.current_weather.temperature + "°C";
                document.getElementById('weather-desc').innerText = "Wind: " + wData.current_weather.windspeed + " km/h";
                document.getElementById('weather-date').innerText = new Date().toDateString();
            } catch(e) { console.log("Weather error", e); }
        }

        function previewColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
            document.documentElement.style.setProperty('--primary-gradient', `linear-gradient(135deg, ${color} 0%, ${adjustColor(color,-20)} 100%)`);
            document.documentElement.style.setProperty('--primary-shadow', hexToRgba(color, 0.4));
        }
        function previewBrand(text) { document.querySelector('.login-box h2').innerText = text || "POS Login"; }
        function applyBranding() {
            const savedName = localStorage.getItem('nz_brand_name_' + currentUserEmail);
            const savedColor = localStorage.getItem('nz_theme_color_' + currentUserEmail);
            if(savedName) { document.querySelectorAll('.brand-text').forEach(el => el.innerText = savedName); document.title = savedName + " POS"; }
            if(savedColor) {
                document.documentElement.style.setProperty('--primary-color', savedColor);
                document.documentElement.style.setProperty('--primary-gradient', `linear-gradient(135deg, ${savedColor} 0%, ${adjustColor(savedColor,-20)} 100%)`);
                document.documentElement.style.setProperty('--primary-shadow', hexToRgba(savedColor, 0.4));
            }
        }
        function toggleDarkMode() { isDarkMode = !isDarkMode; localStorage.setItem('nz_dark_mode', isDarkMode); applyTheme(); }
        function applyTheme() {
            if (isDarkMode) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
            renderChart();
        }
        function toggleLang() { currentLang = currentLang === 'en' ? 'si' : 'en'; localStorage.setItem('nz_lang', currentLang); applyLang(); }
        function applyLang() {
            document.getElementById('curr-lang').innerText = currentLang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[currentLang][key]) {
                    const icon = el.querySelector('i');
                    if(icon) { el.innerHTML = ''; el.appendChild(icon); el.appendChild(document.createTextNode(" " + translations[currentLang][key])); } 
                    else { el.innerText = translations[currentLang][key]; }
                }
            });
        }
        function adjustColor(color, amount) { return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)); }
        function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }

        function attemptLogin() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const brandName = document.getElementById('loginBrandName').value;
            const brandColor = document.getElementById('loginBrandColor').value;
            const users = JSON.parse(localStorage.getItem('nz_master_users_db')) || [];
            const user = users.find(u => u.email === email && u.pass === pass);
            if(user) {
                const today = new Date().toISOString().split('T')[0];
                if(today >= user.start && today <= user.end) {
                    localStorage.setItem('nz_current_user', email);
                    if(brandName) localStorage.setItem('nz_brand_name_' + email, brandName);
                    if(brandColor) localStorage.setItem('nz_theme_color_' + email, brandColor);
                    location.reload();
                } else { alert("Expired!"); }
            } else { alert("Invalid credentials!"); }
        }
        function logout() { if(confirm("Logout?")) { localStorage.removeItem('nz_current_user'); location.reload(); } }

        function addToLog(action, details) { const time = new Date().toLocaleString(); data.logs.unshift({ time, action, details }); if(data.logs.length > 50) data.logs.pop(); saveData(); }
        
        function loadData() {
            try {
                data.orders = JSON.parse(localStorage.getItem(`nz_ord_${currentUserEmail}`)) || [];
                data.products = JSON.parse(localStorage.getItem(`nz_prod_${currentUserEmail}`)) || [];
                data.customers = JSON.parse(localStorage.getItem(`nz_cust_${currentUserEmail}`)) || [];
                data.payments = JSON.parse(localStorage.getItem(`nz_pay_${currentUserEmail}`)) || [];
                data.logs = JSON.parse(localStorage.getItem(`nz_logs_${currentUserEmail}`)) || [];
                data.settings = JSON.parse(localStorage.getItem(`nz_set_${currentUserEmail}`)) || {name:'', addr:'', phone:'', footer:''};
                
                // MIGRATION: Convert old String secrets to Array if necessary
                data.products.forEach(p => {
                    if (typeof p.secret === 'string') {
                        if (p.secret.trim() === '') {
                            p.secret = [];
                        } else {
                            p.secret = p.secret.split('\n').filter(k => k.trim() !== '');
                        }
                    } else if (!p.secret) {
                        p.secret = [];
                    }
                });

                const savedBrand = localStorage.getItem('nz_brand_name_' + currentUserEmail);
                if(!data.settings.name && savedBrand) data.settings.name = savedBrand;
                document.getElementById('setShopName').value = data.settings.name || '';
                document.getElementById('setShopAddr').value = data.settings.addr || '';
                document.getElementById('setShopPhone').value = data.settings.phone || '';
                document.getElementById('setFooter').value = data.settings.footer || '';
                renderUI();
                renderKeys();
            } catch(e) { console.error("Data load error", e); }
        }
        function saveData() {
            if(!currentUserEmail) return;
            localStorage.setItem(`nz_ord_${currentUserEmail}`, JSON.stringify(data.orders));
            localStorage.setItem(`nz_prod_${currentUserEmail}`, JSON.stringify(data.products));
            localStorage.setItem(`nz_cust_${currentUserEmail}`, JSON.stringify(data.customers));
            localStorage.setItem(`nz_pay_${currentUserEmail}`, JSON.stringify(data.payments));
            localStorage.setItem(`nz_logs_${currentUserEmail}`, JSON.stringify(data.logs));
            localStorage.setItem(`nz_set_${currentUserEmail}`, JSON.stringify(data.settings));
            renderUI();
            renderKeys();
        }
        function saveShopSettings(e) {
            e.preventDefault();
            data.settings.name = document.getElementById('setShopName').value;
            data.settings.addr = document.getElementById('setShopAddr').value;
            data.settings.phone = document.getElementById('setShopPhone').value;
            data.settings.footer = document.getElementById('setFooter').value;
            localStorage.setItem('nz_brand_name_' + currentUserEmail, data.settings.name);
            applyBranding(); saveData(); alert("Saved!");
        }

        function sendPromo() {
            const emails = data.customers.length; 
            if(emails > 0) alert("Opening Mail App to send promo to " + emails + " customers.");
            window.location.href = "mailto:?bcc=" + data.customers.map(c => "customer@example.com").join(',') + "&subject=Special Offer&body=Hello, check out our new items!";
        }

        function searchCustomer(q) {
            const filter = q.toUpperCase();
            const table = document.getElementById('tableCustomers');
            const tr = table.getElementsByTagName('tr');
            for (let i = 0; i < tr.length; i++) {
                const tdName = tr[i].getElementsByTagName('td')[0];
                const tdId = tr[i].getElementsByTagName('td')[1];
                if (tdName || tdId) {
                    if ((tdName.innerText.toUpperCase().indexOf(filter) > -1) || (tdId.innerText.indexOf(filter) > -1)) { tr[i].style.display = ""; } else { tr[i].style.display = "none"; }
                }
            }
        }

        function viewHistory(custName) {
            const hist = data.orders.filter(o => o.cust === custName);
            const content = document.getElementById('history-content');
            content.innerHTML = `<h4>Orders for ${custName}</h4>`;
            if(hist.length === 0) content.innerHTML += "<p>No orders found.</p>";
            else {
                let ul = "<ul style='padding-left:20px; margin-top:10px;'>";
                hist.forEach(h => { ul += `<li>${h.date}: ${h.prod} (${h.qty}) - ${h.total}</li>`; });
                ul += "</ul>"; content.innerHTML += ul;
            }
            openModal('modalHistory');
        }

        function renderUI() {
            document.getElementById('dash-orders-count').innerText = data.orders.length;
            document.getElementById('dash-products-count').innerText = data.products.length;
            document.getElementById('dash-customers-count').innerText = data.customers.length;

            const tbO = document.getElementById('tableOrders'); tbO.innerHTML = '';
            data.orders.sort((a,b) => new Date(b.date) - new Date(a.date));
            let totalSales = 0;
            data.orders.forEach((o, i) => {
                if(o.status !== 'Replaced') totalSales += parseInt(o.total);
                
                // FEATURE 32: DYNAMIC STATUS
                let statusClass = 'status-sale';
                let statusText = 'Completed';
                
                if(o.status === 'Replaced') {
                    statusClass = 'status-replaced';
                    statusText = 'Replaced';
                } else if(o.type === 'Subscription') {
                    const today = new Date().setHours(0,0,0,0);
                    const endDate = o.end ? new Date(o.end).setHours(0,0,0,0) : 0;
                    if(endDate < today) {
                        statusClass = 'status-expired';
                        statusText = 'Expired';
                    } else {
                        statusClass = 'status-active';
                        statusText = 'Active';
                    }
                }

                let endDateDisplay = o.end ? o.end : '-';
                let startDateDisplay = o.start ? o.start : '-'; // Added Start Date
                
                // FEATURE 37 & 67: SLIP BUTTON
                let slipBtn = o.slip ? `<button class="btn-icon" title="View Slip" onclick="viewSlip('${o.slip}')"><i class="fas fa-receipt"></i></button>` : '';

                tbO.innerHTML += `<tr class="${statusClass}">
                <td>${o.cust}</td>
                <td>${o.prod}</td>
                <td><small class="category-badge">${o.type || 'Sale'}</small></td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${startDateDisplay}</td> <td>${endDateDisplay}</td>
                <td>
                    <button class="btn-pdf-send" onclick="generateAndSendInvoice(${i})" title="Send Invoice PDF">
                        <i class="fas fa-file-pdf"></i> PDF Inv
                    </button>
                    ${o.secret ? `<button class="btn-icon" onclick="copyKey('${o.secret.replace(/\n/g, '\\n')}')" title="Copy Key"><i class="fas fa-copy"></i></button>` : ''}
                    ${slipBtn}
                    <button class="btn-icon" style="color:#F59E0B" onclick="replaceOrder(${i})" title="Replace Key"><i class="fas fa-sync-alt"></i></button>
                    <button class="btn-icon" style="color:#EF4444" onclick="del('orders',${i})" title="Delete"><i class="fas fa-trash"></i></button>
                </td></tr>`;
            });
            document.getElementById('rep-total').innerText = "LKR " + totalSales;

            const grP = document.getElementById('productsGrid'); grP.innerHTML = '';
            data.products.forEach((p, i) => {
                let badge = p.qty < 5 ? 'style="background:#EF4444"' : '';
                const imgSrc = p.img || "https://via.placeholder.com/150?text=No+Image";
                grP.innerHTML += `<div class="product-card"><span class="stock-badge" ${badge}>Qty: ${p.qty}</span><img src="${imgSrc}"><h4>${p.name}</h4><p class="category-badge">${p.cat||'General'}</p><p style="font-size:12px;color:var(--text-muted)">${p.desc.substring(0,30)}</p><span>LKR ${p.price}</span><br><small>War: ${p.warranty||'None'}</small><button class="btn-icon" style="color:#EF4444; width:40px; height:40px; margin-top:10px;" onclick="del('products',${i})"><i class="fas fa-trash-alt"></i></button></div>`;
            });

            const tbC = document.getElementById('tableCustomers'); tbC.innerHTML = '';
            data.customers.forEach((c, i) => {
                let link = `https://wa.me/94${c.phone.replace(/\D/g,'').slice(-9)}`;
                let stars = c.points || 0;
                tbC.innerHTML += `<tr><td>${c.name}</td><td>${c.memId||'-'}</td><td><a href="${link}" class="whatsapp-link"><i class="fab fa-whatsapp"></i> ${c.phone}</a></td>
                <td style="color:#D64213; font-weight:bold;">${stars} Stars</td>
                <td>
                    <button class="btn-icon" onclick="viewHistory('${c.name}')" title="History"><i class="fas fa-history"></i></button>
                    <button class="btn-icon" style="color:#EF4444" onclick="del('customers',${i})"><i class="fas fa-trash"></i></button>
                </td></tr>`;
            });

            const tbP = document.getElementById('tablePayments'); tbP.innerHTML = '';
            data.payments.forEach((p, i) => {
                let cls = p.status === 'Complete' ? 'status-complete' : 'status-pending';
                tbP.innerHTML += `<tr><td>${p.cust}</td><td><strong>${p.amt}</strong></td><td><span class="status-badge ${cls}" onclick="togPay(${i})">${p.status}</span></td><td><button class="btn-icon" style="color:#EF4444" onclick="del('payments',${i})"><i class="fas fa-trash"></i></button></td></tr>`;
            });

            const logCont = document.getElementById('logs-container'); logCont.innerHTML = '';
            data.logs.forEach(l => { logCont.innerHTML += `<div class="log-entry"><span class="log-time">${l.time}</span> <span><strong>${l.action}</strong> - ${l.details}</span></div>`; });

            renderTopSelling(); checkExp(); updateDropdowns(); renderChart();
        }

        /* ----------------------------------------------------- */
        /* NEW: PDF INVOICE & WHATSAPP FUNCTION                */
        /* ----------------------------------------------------- */
        async function generateAndSendInvoice(i) {
            const o = data.orders[i];
            const p = data.products.find(x => x.name === o.prod);
            
            // 1. Get Settings
            const shopName = data.settings.name || "NexaZone Digital";
            const shopAddr = data.settings.addr || "";
            const shopPhone = data.settings.phone || "";
            const footerMsg = data.settings.footer || "Thank you!";

            // 2. Initialize PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // 3. Add Content (Professional Layout)
            // Title
            doc.setFontSize(22);
            doc.setTextColor(214, 66, 19); // Theme color
            doc.text(shopName, 14, 20);
            
            // Address Info
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`${shopAddr} \nTel: ${shopPhone}`, 14, 30);

            // Invoice Details Right Side
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text("INVOICE", 160, 20);
            doc.setFontSize(10);
            doc.text(`Date: ${o.date}`, 160, 28);
            doc.text(`Customer: ${o.cust}`, 160, 34);

            // Table
            doc.autoTable({
                startY: 50,
                head: [['Item', 'Type', 'Qty', 'Price', 'Total']],
                body: [
                    [o.prod, o.type, o.qty, o.price, o.total]
                ],
                theme: 'grid',
                headStyles: { fillColor: [214, 66, 19] }
            });

            // Total Section
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(14);
            doc.text(`Total Amount: LKR ${o.total}`, 130, finalY);

            // Warranty Info
            if(p && p.warranty) {
                finalY += 10;
                doc.setFontSize(10);
                doc.text(`Warranty: ${p.warranty}`, 14, finalY);
            }

            // Key/Secret info (Optional)
            if(o.secret) {
                finalY += 10;
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text("Digital Key Included:", 14, finalY);
                doc.setFont("courier");
                doc.text(o.secret, 14, finalY + 5);
                doc.setFont("helvetica");
                finalY += 15;
            }

            // Footer
            finalY += 20;
            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text(footerMsg, 105, finalY, null, null, "center");

            // 4. Save PDF
            const fileName = `Invoice_${o.cust.replace(/\s/g, '_')}_${o.date}.pdf`;
            doc.save(fileName);

            // 5. Open WhatsApp
            const cust = data.customers.find(c => c.name === o.cust);
            if(cust) {
                let phone = cust.phone.replace(/\D/g,'');
                if(phone.startsWith('0')) phone = '94' + phone.substring(1);
                
                // Instruct User
                alert(`PDF Invoice Downloaded: ${fileName}\n\nWhatsApp will open now. Please attach the downloaded file to the chat.`);

                const msg = encodeURIComponent(`Dear ${o.cust},\n\nPlease find your invoice attached for your purchase of ${o.prod}.\n\nTotal: LKR ${o.total}\n\nThank you,\n${shopName}`);
                window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
            } else {
                alert("Customer phone number not found! PDF saved only.");
            }
        }

        // --- NEW HELPERS ---
        function copyKey(text) {
            navigator.clipboard.writeText(text);
            alert("Key Copied!");
        }

        function viewSlip(src) {
            document.getElementById('viewSlipImg').src = src;
            openModal('modalViewSlip');
        }

        // FEATURE 16: REPLACE ORDER
        function replaceOrder(i) {
            const oldOrder = data.orders[i];
            if(oldOrder.status === 'Replaced') return;

            if(confirm("Replace this order? A new key will be issued from stock.")) {
                // Find product
                const pIdx = data.products.findIndex(p => p.name === oldOrder.prod);
                if(pIdx === -1) { alert("Product not found!"); return; }
                const p = data.products[pIdx];

                // Check stock
                if(p.qty <= 0) { alert("No stock available for replacement!"); return; }

                // Get new key
                let newKey = '';
                if(Array.isArray(p.secret) && p.secret.length > 0) {
                    newKey = p.secret[0];
                    p.secret.shift();
                    p.qty--;
                } else {
                    alert("No keys in bank!"); return;
                }

                // Mark old replaced
                oldOrder.status = 'Replaced';

                // Create new order (0 Price for warranty replacement)
                const newOrder = { ...oldOrder };
                newOrder.date = new Date().toISOString().split('T')[0];
                newOrder.status = 'Active';
                newOrder.secret = newKey;
                newOrder.total = 0; // Free replacement
                
                data.orders.push(newOrder);
                addToLog("Order Replaced", `Replaced ${oldOrder.prod} for ${oldOrder.cust}`);
                saveData();
                alert("Replacement Issued!");
            }
        }

        // --- KEY ADDITION LOGIC ---
        function openAddKeyModal(mode) {
            let modalId = mode === 'bulk' ? 'modalBulkKeys' : 'modalSingleKey';
            openModal(modalId);
            const selectId = mode === 'bulk' ? 'keyProdSelectBulk' : 'keyProdSelectSingle';
            const select = document.getElementById(selectId);
            
            select.innerHTML = '<option value="">Select a Product...</option>';
            data.products.forEach((p, index) => {
                select.innerHTML += `<option value="${index}">${p.name}</option>`;
            });
        }

        function handleSaveBulkKeys() {
            const pIdx = document.getElementById('keyProdSelectBulk').value;
            const newKeys = document.getElementById('newKeyDataBulk').value;

            if(pIdx === "" || newKeys.trim() === "") { alert("Invalid input"); return; }

            const p = data.products[pIdx];
            const newKeyList = newKeys.split('\n').filter(k => k.trim() !== '');
            const count = newKeyList.length;

            if(count > 0) {
                if(!Array.isArray(p.secret)) p.secret = [];
                newKeyList.forEach(k => p.secret.push(k));
                p.qty = parseInt(p.qty) + count;
                addToLog("Keys Added", `${count} keys added to ${p.name}`);
                saveData(); 
                closeModal('modalBulkKeys');
                document.getElementById('newKeyDataBulk').value = ''; 
                alert("Bulk keys added!");
            }
        }

        function handleSaveSingleKey() {
            const pIdx = document.getElementById('keyProdSelectSingle').value;
            const newKeyData = document.getElementById('newKeyDataSingle').value;

            if(pIdx === "" || newKeyData.trim() === "") { alert("Invalid input"); return; }

            const p = data.products[pIdx];
            if(!Array.isArray(p.secret)) p.secret = [];
            p.secret.push(newKeyData);
            p.qty = parseInt(p.qty) + 1;

            addToLog("Key Added", `1 Single Key Data added to ${p.name}`);
            saveData(); 
            closeModal('modalSingleKey');
            document.getElementById('newKeyDataSingle').value = ''; 
            alert("Single Key Block added!");
        }

        function deleteKey(pIndex, kIndex) {
            if(confirm("Delete this key? Stock will be reduced by 1.")) {
                const p = data.products[pIndex];
                p.secret.splice(kIndex, 1);
                p.qty = Math.max(0, parseInt(p.qty) - 1); 
                saveData(); 
            }
        }

        function renderKeys() {
            const container = document.getElementById('key-bank-container');
            if(!container) return;
            container.innerHTML = '';

            data.products.forEach((p, pIndex) => {
                if(Array.isArray(p.secret) && p.secret.length > 0) {
                    let rows = '';
                    p.secret.forEach((key, kIndex) => {
                        let custOptions = `<option value="">Select Customer...</option>`;
                        data.customers.forEach(c => { custOptions += `<option value="${c.name}">${c.name}</option>`; });
                        let displayKey = key.replace(/\n/g, '<br>');

                        rows += `
                        <div class="key-row">
                            <span style="flex:1; margin-right:10px; font-size:12px;">${displayKey}</span>
                            <div class="key-actions">
                                <select class="key-select" id="key-select-${pIndex}-${kIndex}">${custOptions}</select>
                                <button class="btn-primary" style="padding:5px 10px; font-size:12px;" onclick="sendSpecificKey(${pIndex}, ${kIndex}, 'key-select-${pIndex}-${kIndex}')"><i class="fas fa-paper-plane"></i></button>
                                <button class="btn-icon" style="color:#EF4444; width:30px; height:30px;" onclick="deleteKey(${pIndex}, ${kIndex})"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                    });

                    const imgSrc = p.img || "https://via.placeholder.com/60?text=No+Image";
                    container.innerHTML += `
                    <div class="key-bank-card">
                        <div class="key-bank-header"><img src="${imgSrc}"><div><h3 style="margin:0;">${p.name}</h3><small style="color:var(--text-muted)">${p.secret.length} Keys Available</small></div></div>
                        <div>${rows}</div>
                    </div>`;
                }
            });

            if(container.innerHTML === '') container.innerHTML = `<div class="empty-placeholder">No Keys found. Click "Add Keys" above.</div>`;
        }

        function sendSpecificKey(pIndex, kIndex, selectId) {
            const custName = document.getElementById(selectId).value;
            if(!custName) { alert("Please select a customer first!"); return; }

            const p = data.products[pIndex];
            const keyToSend = p.secret[kIndex];

            p.secret.splice(kIndex, 1);
            p.qty = Math.max(0, p.qty - 1); 

            const today = new Date().toISOString().split('T')[0];
            const order = { cust: custName, prod: p.name, price: p.price, qty: 1, total: p.price, date: today, type: 'Sale', status: 'Active', secret: keyToSend };
            
            const cIdx = data.customers.findIndex(c => c.name === custName);
            if(cIdx > -1) data.customers[cIdx].points = (data.customers[cIdx].points || 0) + 10;

            data.orders.push(order);
            addToLog("Manual Key Send", `${p.name} key sent to ${custName}`);
            saveData(); 

            const cust = data.customers.find(c => c.name === custName);
            if(cust) {
                let phone = cust.phone.replace(/\D/g,'');
                if(phone.startsWith('0')) phone = '94' + phone.substring(1);
                const msg = encodeURIComponent(`*ORDER CONFIRMATION*\n\nProduct: ${p.name}\nPrice: ${p.price}\n\n🔐 *YOUR KEY/DATA:*\n${keyToSend}\n\nThank you!`);
                window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
            }
        }

        function renderChart() {
            const ctx = document.getElementById('salesChart'); if(!ctx) return;
            const days = [], sales = []; const today = new Date();
            for(let i=6; i>=0; i--) {
                const d = new Date(today); d.setDate(today.getDate() - i); const dateStr = d.toISOString().split('T')[0];
                days.push(dateStr);
                const total = data.orders.filter(o => o.date === dateStr && o.status !== 'Replaced').reduce((sum, o) => sum + parseInt(o.total), 0);
                sales.push(total);
            }
            const textColor = isDarkMode ? '#9CA3AF' : '#6B7280';
            const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
            if(salesChartInstance) salesChartInstance.destroy();
            salesChartInstance = new Chart(ctx, { type: 'bar', data: { labels: days, datasets: [{ label: 'Revenue (LKR)', data: sales, backgroundColor: brandColor, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
        }

        function renderTopSelling() {
            const list = document.getElementById('top-selling-list'); list.innerHTML = '';
            let counts = {};
            data.orders.forEach(o => { if(o.status!=='Replaced') counts[o.prod] = (counts[o.prod] || 0) + parseInt(o.qty); });
            const sorted = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 5);
            sorted.forEach((prod, idx) => { list.innerHTML += `<li><div><span class="top-rank">${idx+1}</span> ${prod}</div> <strong>${counts[prod]} Sold</strong></li>`; });
        }

        function handleReturn(i) {
            if(confirm("Mark this order as Returned? Stock will be restored and Stars deducted.")) {
                const o = data.orders[i];
                o.status = 'Replaced'; // Using Replaced status for return visual
                const p = data.products.find(x => x.name === o.prod);
                if(p) p.qty = parseInt(p.qty) + parseInt(o.qty);
                
                const pointsToDeduct = 10;
                const cIdx = data.customers.findIndex(c => c.name === o.cust);
                if(cIdx > -1) {
                    data.customers[cIdx].points = (data.customers[cIdx].points || 0) - pointsToDeduct;
                    if(data.customers[cIdx].points < 0) data.customers[cIdx].points = 0; 
                }

                addToLog("Order Return", `${o.prod} returned by ${o.cust}`);
                saveData();
            }
        }

        function checkExp() {
            const ac = document.getElementById('expiration-alerts'); ac.innerHTML = ''; 
            const today = new Date(); today.setHours(0,0,0,0);
            
            data.orders.forEach(o => {
                if(o.type === 'Subscription' && o.end) {
                    const endDate = new Date(o.end); endDate.setHours(0,0,0,0);
                    const diffTime = endDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays >= 0 && diffDays <= 2) { 
                        ac.innerHTML += `<div class="alert-card">
                        <span>⚠️ Subscription Expiring: <strong>${o.cust}</strong> (${o.prod}) <br>
                        <small>Ends: ${o.end} (${diffDays === 0 ? 'Today' : diffDays + ' days left'})</small>
                        </span></div>`; 
                    }
                }
            });
        }

        function updateDropdowns() {
            const cList = `<option value="">Select...</option>` + data.customers.map(c => `<option>${c.name}</option>`).join('');
            document.getElementById('oCust').innerHTML = cList; document.getElementById('payCust').innerHTML = cList;
            const pList = `<option value="">Select...</option>` + data.products.map(p => `<option>${p.name}</option>`).join('');
            document.getElementById('oProd').innerHTML = pList;
        }

        window.updPrice = function() {
            const n = document.getElementById('oProd').value;
            const p = data.products.find(x => x.name === n);
            if(p) { document.getElementById('oPrice').value = p.price; calcTot(); }
        }
        window.calcTot = function() { document.getElementById('oTotal').value = document.getElementById('oPrice').value * document.getElementById('oQty').value; }

        function toggleSubFields() {
            const type = document.getElementById('oType').value;
            const subDiv = document.getElementById('subFields');
            if(type === 'Subscription') {
                subDiv.style.display = 'block';
                document.getElementById('oStart').value = new Date().toISOString().split('T')[0];
            } else {
                subDiv.style.display = 'none';
                document.getElementById('oStart').value = "";
                document.getElementById('oEnd').value = "";
            }
        }

        window.handleOrder = function(e) {
            e.preventDefault();
            const prod = document.getElementById('oProd').value;
            const qty = document.getElementById('oQty').value;
            const type = document.getElementById('oType').value;
            const sDate = document.getElementById('oStart').value;
            const eDate = document.getElementById('oEnd').value;
            const total = parseInt(document.getElementById('oTotal').value);
            const custName = document.getElementById('oCust').value;
            const slipFile = document.getElementById('oSlip').files[0]; // Feature 37

            const pIdx = data.products.findIndex(x => x.name === prod);
            
            if(pIdx > -1) {
                if(data.products[pIdx].qty >= qty) {
                    
                    let assignedSecret = '';
                    let p = data.products[pIdx];
                    
                    if(Array.isArray(p.secret) && p.secret.length > 0) {
                        assignedSecret = p.secret[0]; 
                        p.secret.shift(); 
                    }

                    data.products[pIdx].qty -= qty; 

                    const createOrder = (slipData) => {
                        const order = {
                            cust: custName, 
                            prod: prod, 
                            price: document.getElementById('oPrice').value, 
                            qty: qty, 
                            total: total, 
                            date: document.getElementById('oDate').value, 
                            type: type, 
                            status: 'Active',
                            start: sDate, 
                            end: eDate,
                            secret: assignedSecret,
                            slip: slipData // Save Slip Image
                        };

                        const pointsEarned = 10;
                        const cIdx = data.customers.findIndex(c => c.name === custName);
                        if(cIdx > -1) data.customers[cIdx].points = (data.customers[cIdx].points || 0) + pointsEarned;

                        data.orders.push(order);
                        addToLog("New Order", `${order.prod} (${type})`);
                        saveData(); 
                        closeModal('modalOrder'); 
                        e.target.reset();
                        document.getElementById('subFields').style.display = 'none';
                    };

                    if(slipFile) {
                        const r = new FileReader();
                        r.onload = ev => createOrder(ev.target.result);
                        r.readAsDataURL(slipFile);
                    } else {
                        createOrder(null);
                    }

                } else { alert("Low Stock!"); }
            }
        }

        window.handleProduct = function(e) {
            e.preventDefault();
            const f = document.getElementById('pImg').files[0];
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = ev => { 
                const img = new Image(); img.src = ev.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                    cvs.width = 500; cvs.height = 500; ctx.drawImage(img, 0, 0, 500, 500);
                    const prodName = document.getElementById('pName').value;
                    let initialQty = document.getElementById('pStock').value;

                    data.products.push({
                        name:prodName, 
                        desc:document.getElementById('pDesc').value, 
                        price:document.getElementById('pPrice').value, 
                        qty:initialQty, 
                        img:cvs.toDataURL('image/jpeg', 0.8),
                        cat: document.getElementById('pCat').value, 
                        warranty: document.getElementById('pWarranty').value,
                        secret: [] // Init empty array
                    }); 
                    addToLog("Product Added", prodName); saveData(); closeModal('modalProduct'); e.target.reset();
                };
            };
        };

        window.handleCustomer = function(e) { 
            e.preventDefault(); 
            const name = document.getElementById('cName').value;
            const memId = document.getElementById('cMemId').value || 'M-' + Math.floor(Math.random()*10000);
            data.customers.push({name:name, phone:document.getElementById('cPhone').value, date:document.getElementById('cDate').value, memId: memId, points: 0}); 
            addToLog("Customer Added", name); saveData(); closeModal('modalCustomer'); e.target.reset(); 
        };
        
        window.handlePayment = function(e) { 
            e.preventDefault(); 
            data.payments.push({cust:document.getElementById('payCust').value, amt:document.getElementById('payAmount').value, status:document.getElementById('payStatus').value}); 
            addToLog("Payment Added", document.getElementById('payCust').value); saveData(); closeModal('modalPayment'); e.target.reset(); 
        };

        window.del = function(k, i) { if(confirm("Delete?")) { addToLog("Deleted Item", k); data[k].splice(i,1); saveData(); } };
        window.togPay = function(i) { data.payments[i].status = data.payments[i].status === 'Pending' ? 'Complete' : 'Pending'; saveData(); };

        window.printInv = function(i) {
            const o = data.orders[i];
            const p = data.products.find(x => x.name === o.prod);
            const area = document.getElementById('invoice-print-area');
            document.getElementById('inv-shop-name').innerText = data.settings.name || "NexaZone Digital";
            document.getElementById('inv-shop-details').innerText = `${data.settings.addr || ''} \n ${data.settings.phone || ''}`;
            document.getElementById('inv-details').innerHTML = `<p><strong>Customer:</strong> ${o.cust}</p><p><strong>Item:</strong> ${o.prod}</p><p><strong>Type:</strong> ${o.type||'Sale'}</p><p><strong>Qty:</strong> ${o.qty} x ${o.price}</p>`;
            document.getElementById('inv-total').innerText = "Total: LKR " + o.total;
            document.getElementById('inv-warranty').innerText = (p && p.warranty) ? "Warranty: " + p.warranty : "";
            
            let keyText = "";
            if(o.secret) keyText = `<p style="border:1px dashed black; padding:5px; margin-top:10px;"><strong>KEY/LINK:</strong><br>${o.secret}</p>`;

            document.getElementById('inv-footer').innerHTML = keyText + "<br>" + (data.settings.footer || "Thank You!");
            
            area.style.display = 'block';
            window.print();
            area.style.display = 'none';
        }
        window.backupData = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data)],{type:"application/json"})); a.download='backup.json'; a.click(); };
        window.restoreData = i => { const r=new FileReader(); r.onload=e=>{ if(confirm("Restore?")){data=JSON.parse(e.target.result); saveData(); alert("Done");} }; r.readAsText(i.files[0]); };
        
        window.navigate = function(id) {
            document.querySelectorAll('.page-view').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            let navId = (id === 'home') ? 'nav-home' : 'nav-' + id;
            document.getElementById(navId).classList.add('active');
            
            if(id === 'keys') renderKeys(); 
        };
        window.openModal = function(id) { 
            const m = document.getElementById(id); m.style.display = 'flex'; 
            setTimeout(() => m.classList.add('show'), 10);
            if(id === 'modalOrder'||id==='modalPayment') updateDropdowns();
        };
        window.closeModal = function(id) { 
            const m = document.getElementById(id); m.classList.remove('show'); 
            setTimeout(() => m.style.display = 'none', 300);
        };
        function openProfile() {
            openModal('modalProfile');
            document.getElementById('prof-email').innerText = currentUserEmail;
            const users = JSON.parse(localStorage.getItem('nz_master_users_db')) || [];
            const user = users.find(u => u.email === currentUserEmail);
            if(user) {
                document.getElementById('prof-start').innerText = user.start;
                document.getElementById('prof-end').innerText = user.end;
                const end = new Date(user.end); const now = new Date(); const diff = end - now;
                if(diff > 0) {
                    const days = Math.floor(diff/(1000*60*60*24));
                    const months = Math.floor(days/30);
                    const rDays = days%30;
                    let txt = ""; if(months>0) txt += months + " Months "; txt += rDays + " Days";
                    document.getElementById('prof-countdown').innerText = txt;
                    document.getElementById('prof-countdown').style.color = "#333";
                } else {
                    document.getElementById('prof-countdown').innerText = "EXPIRED";
                    document.getElementById('prof-countdown').style.color = "red";
                }
            }
        }
        document.getElementById('cPhone').addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, '').slice(0, 10);
            if(v.length > 6) v = v.slice(0,3)+' '+v.slice(3,6)+' '+v.slice(6);
            else if(v.length > 3) v = v.slice(0,3)+' '+v.slice(3);
            e.target.value = v;
        });

        function downloadTemplate() {
            const headers = [["Name", "Category", "Description", "Price", "Warranty", "Stock"]];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(headers);
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "NexaZone_Product_Template.xlsx");
        }

        function importExcel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataBytes = new Uint8Array(e.target.result);
                const workbook = XLSX.read(dataBytes, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonResults = XLSX.utils.sheet_to_json(worksheet);

                if(jsonResults.length > 0) {
                    let addedCount = 0;
                    const defaultImg = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";

                    jsonResults.forEach(item => {
                        if(item.Name && item.Price && item.Stock) {
                            data.products.push({
                                name: item.Name,
                                cat: item.Category || 'General',
                                desc: item.Description || '',
                                price: item.Price,
                                warranty: item.Warranty || '',
                                qty: item.Stock,
                                img: defaultImg,
                                secret: []
                            });
                            addedCount++;
                        }
                    });

                    if(addedCount > 0) {
                        addToLog("Bulk Import", `Imported ${addedCount} products`);
                        saveData();
                        alert(`Successfully imported ${addedCount} products!`);
                        input.value = ""; 
                    } else {
                        alert("No valid products found. Please check column headers (Name, Price, Stock).");
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        }

    </script>
</body>
</html>
